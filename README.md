Ты — senior Python developer. Сгенерируй **один автономный Python-скрипт** (один файл, например `clinic_console_app.py`) для стоматологической клиники, который объединяет:  
1) выбор данных (CSV/JSON) → выбор HTML-шаблона → выбор `invoice_id` → генерация PDF через WeasyPrint → сохранение в `/output` → авто-открытие PDF;  
2) склад материалов (добавление/списание/алерты по минимальному остатку и срокам годности);  
3) отчёты по складу (расходы/поступления/стоимость, сводка, массовый экспорт) с экспортом в **Excel/CSV** и красивым форматированием Excel.

### Ограничения и окружение
- Скрипт должен работать на **Windows и macOS** (допускается Linux как бонус).  
- Должен работать в консоли без GUI.  
- Не использовать внешние сервисы.  
- Все пути **относительные**:  
  - данные: `./data`  
  - шаблоны: `./templates`  
  - выход: `./output`  
  - база склада: `./warehouse.db` (SQLite)  
  - шрифты: `./fonts` (если нужны)  
- При старте скрипт должен создать директории, если их нет.

### Зависимости (использовать и импортировать)
- `weasyprint` — генерация PDF.
- `jinja2` — подстановка данных в HTML-шаблон.
- `pandas` — чтение CSV и экспорт CSV (или `csv` для чтения, но pandas предпочтительно).
- стандартная библиотека `json` — чтение JSON.
- `sqlalchemy` — SQLite + модели склада + запросы отчётов.
- `openpyxl` — экспорт в Excel и форматирование (цвета, границы, автоширина).
- `rich` — аккуратное меню/таблицы/сообщения.
- `typer` НЕ использовать (нужен именно сценарий через `input`), но допускается, если будет отдельный режим — по умолчанию всё равно интерактивно.

### 1) Загрузка файлов данных и шаблонов
При запуске скрипт должен:
1. Просканировать `./data` и собрать **все доступные файлы**:
   - `*.csv` (читать через pandas)
   - `*.json` (читать через json)
2. Просканировать `./templates` и собрать **все** `*.html` шаблоны.
3. Вывести красивое меню в консоли (нумерация):
   - список доступных файлов данных (с указанием типа: CSV/JSON)
   - список доступных HTML-шаблонов

### 2) Интерактивный выбор пользователем
Скрипт должен через `input()`:
1. Предложить выбрать **один** файл данных (CSV или JSON).
2. Предложить выбрать **один** HTML-шаблон.
3. После загрузки данных вывести список доступных “чеков/счетов” по `invoice_id`:
   - если данных много — показывать первые N (например 30) и дать поиск по подстроке
   - или пагинацию (опционально)
4. Пользователь выбирает конкретный `invoice_id`.

### 3) Формат данных (важно)
Скрипт должен поддерживать минимум два формата входных данных:

**A) JSON**
- либо объект вида:
```json
{"invoices": [ { "invoice_id": "...", ... }, ... ]}
```
- либо список инвойсов:
```json
[ { "invoice_id": "...", ... }, ... ]
```
- либо один invoice-объект:
```json
{ "invoice_id": "...", ... }
```

**B) CSV**
- одна строка = один invoice (упрощённый вариант), поля минимум: `invoice_id` + любые другие.
- если есть вложенные услуги, допускается поле `services_json` (строка JSON), которое нужно распарсить в список услуг.

Нужно реализовать функцию извлечения `invoice_id` и получения invoice по id, устойчивую к разным форматам.

### 4) Генерация PDF (WeasyPrint + кириллица)
После выбора `invoice_id`:
1. Данные должны быть подставлены в выбранный HTML-шаблон через Jinja2.  
   - Переменная в шаблоне должна называться `invoice` (например `{{ invoice.patient.full_name }}`).
2. Сгенерировать PDF через WeasyPrint.
3. Обеспечить поддержку кириллицы:
   - подключить `DejaVu Sans` или `Roboto`;
   - если шрифт файл лежит в `./fonts`, подключить через `@font-face` и `base_url`;
   - если шрифтов нет — использовать системный DejaVu Sans при наличии, но лучше реализовать механизм: “если найден `fonts/DejaVuSans.ttf` — использовать его”.
4. Сохранить PDF в `./output` с именем вида:
   - `invoice_<invoice_id>_<YYYYMMDD_HHMMSS>.pdf`
5. После генерации автоматически открыть PDF:
   - Windows: `os.startfile`
   - macOS: `subprocess.run(["open", path])`
   - Linux (опционально): `xdg-open`

### 5) Склад стоматологических материалов (SQLite)
Нужно реализовать мини-систему склада внутри того же скрипта:
- Таблица материалов:
  - `id`, `name`, `material_type` (consumable/medicine/instrument/equipment), `quantity`, `unit`, `unit_price`, `supplier`, `expiry_date`, `min_stock`, `sku`, timestamps
- Таблица движений:
  - `id`, `material_id`, `movement_type` ("in"/"out"), `quantity`, `unit_price`, `total_price`, `reason`, `notes`, `created_at`

Интерактивные команды склада в меню:
- “Добавить материал”
- “Списать материал”
- “Поступление материала”
- “Показать склад (таблица)”
- “Алерты”:
  - низкий запас (quantity <= min_stock)
  - срок годности истекает в N дней (например 30)

### 6) Отчёты по складу (таблица/Excel/CSV)
Нужно реализовать отчёты (выбор из меню):
- Отчёт по расходам за период (по умолчанию 30 дней):
  - группировка по материалу: total qty, total cost, count transactions
- Отчёт по поступлениям за период:
  - группировка по материалу/поставщику
- Стоимость текущего склада:
  - сумма (quantity * unit_price) по каждому материалу + общий итог
- Краткая сводка:
  - стоимость склада
  - расходы за 7 дней (топ-5)
  - расходы за 30 дней (топ-5)
- Массовый экспорт всех отчётов:
  - в Excel (несколько файлов или один файл с листами — выбери один подход и реализуй)
  - в CSV (по одному файлу на отчёт)

### 7) Экспорт в Excel (красивое оформление)
Для Excel (`openpyxl`) сделать форматирование:
- заголовок отчёта (merged cells, цветной фон)
- header row с цветом
- границы ячеек
- автоширина столбцов
- чередование цвета строк (zebra)

### 8) Заполнение готовых PDF-форм (опционально, но желательно)
Добавь пункт меню:
- “Заполнить PDF-форму (акт/отчёт)”
- Выбор PDF-шаблона из `./templates/*.pdf`
- Выбор JSON данных из `./data`
- Заполнение через библиотеку pypdf (если включаешь — добавь зависимость и код)
- Сохранение в `./output`

(Если это усложняет — реализуй как отдельную функцию-заготовку с понятным TODO.)

### 9) Главное меню (очень важно)
При запуске показывай главное меню (аккуратное, нумерованное), например:
1. Генерация PDF счета/чека из HTML (CSV/JSON → invoice_id → PDF)
2. Склад: показать материалы
3. Склад: добавить материал
4. Склад: поступление
5. Склад: списание
6. Склад: алерты (минимум/срок годности)
7. Отчёты: расходы
8. Отчёты: поступления
9. Отчёты: стоимость склада
10. Отчёты: сводка
11. Отчёты: экспорт всех
0. Выход

Меню должно:
- валидировать ввод (только числа в диапазоне)
- позволять возвращаться назад
- не падать при ошибках в данных (показывать дружелюбное сообщение)

### 10) Качество кода
- Код должен быть читаемым и структурированным:
  - функции: `scan_data_files()`, `scan_templates()`, `choose_from_list()`, `render_invoice_pdf()`, `open_file()`, `init_db()`, `inventory_add()`, `inventory_move()`, `report_expenses()`, `export_excel()` и т.д.
- Добавить типы (`typing`) и docstring.
- Валидация критичных полей invoice (например, наличие `invoice_id`).
- Везде использовать `Pathlib`.
- Выводить итоговые пути к созданным файлам.

### 11) Что вернуть в ответ
В ответе выдай:
1. Полный код `clinic_console_app.py` (одним блоком).
2. Минимальный пример `templates/invoice.html` (упрощённый).
3. Минимальный пример `data/invoices.json` и/или `data/invoices.csv`.
4. Инструкцию запуска + список зависимостей (pip install ...).
5. Пояснение, куда положить шрифт (`fonts/DejaVuSans.ttf`) и как он подключается. 
